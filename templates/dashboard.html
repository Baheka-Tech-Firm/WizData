{% extends "base.html" %}

{% block title %}WizData Dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block extra_head %}
{% endblock %}

{% block content %}
            <!-- Page Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-white mb-2">Dashboard</h1>
                <p class="text-gray-400">Monitor your financial data platform performance and insights</p>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Sources -->
                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-gray-600 transition-colors fade-in">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm font-medium">Total Sources</p>
                            <p class="text-2xl font-bold text-white mt-1" id="totalSources">-</p>
                        </div>
                        <div class="p-3 bg-blue-600 rounded-lg">
                            <i data-lucide="database" class="w-6 h-6 text-white"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <span class="text-green-500 text-sm font-medium" id="sourcesChange">+0%</span>
                        <span class="text-gray-400 text-sm ml-1">vs last month</span>
                    </div>
                </div>

                <!-- Tracked Symbols -->
                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-gray-600 transition-colors fade-in">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm font-medium">Tracked Symbols</p>
                            <p class="text-2xl font-bold text-white mt-1" id="trackedSymbols">-</p>
                        </div>
                        <div class="p-3 bg-green-600 rounded-lg">
                            <i data-lucide="trending-up" class="w-6 h-6 text-white"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <span class="text-green-500 text-sm font-medium" id="symbolsChange">+0%</span>
                        <span class="text-gray-400 text-sm ml-1">vs last month</span>
                    </div>
                </div>

                <!-- Data Points -->
                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-gray-600 transition-colors fade-in">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm font-medium">Data Points</p>
                            <p class="text-2xl font-bold text-white mt-1" id="dataPoints">-</p>
                        </div>
                        <div class="p-3 bg-purple-600 rounded-lg">
                            <i data-lucide="activity" class="w-6 h-6 text-white"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <span class="text-green-500 text-sm font-medium" id="dataPointsChange">+0%</span>
                        <span class="text-gray-400 text-sm ml-1">vs last month</span>
                    </div>
                </div>

                <!-- API Requests -->
                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-gray-600 transition-colors fade-in">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm font-medium">API Requests</p>
                            <p class="text-2xl font-bold text-white mt-1" id="apiRequests">-</p>
                        </div>
                        <div class="p-3 bg-yellow-600 rounded-lg">
                            <i data-lucide="zap" class="w-6 h-6 text-white"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <span class="text-green-500 text-sm font-medium" id="requestsChange">+0%</span>
                        <span class="text-gray-400 text-sm ml-1">vs last hour</span>
                    </div>
                </div>
            </div>

            <!-- Chart and Top Performers Row -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <!-- Market Overview Chart -->
                <div class="lg:col-span-2 bg-gray-800 rounded-lg p-6 border border-gray-700">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-white">Market Overview</h3>
                        <div class="flex items-center space-x-2">
                            <button class="time-range-btn px-3 py-1 text-sm rounded bg-blue-600 text-white" data-range="1D">1D</button>
                            <button class="time-range-btn px-3 py-1 text-sm rounded text-gray-400 hover:text-white hover:bg-gray-700" data-range="1W">1W</button>
                            <button class="time-range-btn px-3 py-1 text-sm rounded text-gray-400 hover:text-white hover:bg-gray-700" data-range="1M">1M</button>
                            <button class="time-range-btn px-3 py-1 text-sm rounded text-gray-400 hover:text-white hover:bg-gray-700" data-range="1Y">1Y</button>
                        </div>
                    </div>
                    <div class="h-80">
                        <canvas id="marketChart"></canvas>
                    </div>
                </div>

                <!-- Top Performing Symbols -->
                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold text-white mb-6">Top Performers</h3>
                    <div class="space-y-4" id="topPerformers">
                        <!-- Dynamic content will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Market Insights Table -->
            <div class="bg-gray-800 rounded-lg border border-gray-700">
                <div class="p-6 border-b border-gray-700">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-white">Market Insights</h3>
                        <div class="flex items-center space-x-2">
                            <button class="filter-btn px-3 py-1 text-sm rounded bg-blue-600 text-white" data-filter="all">All</button>
                            <button class="filter-btn px-3 py-1 text-sm rounded text-gray-400 hover:text-white hover:bg-gray-700" data-filter="jse">JSE</button>
                            <button class="filter-btn px-3 py-1 text-sm rounded text-gray-400 hover:text-white hover:bg-gray-700" data-filter="crypto">Crypto</button>
                            <button class="filter-btn px-3 py-1 text-sm rounded text-gray-400 hover:text-white hover:bg-gray-700" data-filter="forex">Forex</button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-700">
                                <th class="text-left p-4 text-gray-400 font-medium">Symbol</th>
                                <th class="text-left p-4 text-gray-400 font-medium">Name</th>
                                <th class="text-left p-4 text-gray-400 font-medium">Sector</th>
                                <th class="text-right p-4 text-gray-400 font-medium">Price</th>
                                <th class="text-right p-4 text-gray-400 font-medium">Change</th>
                                <th class="text-right p-4 text-gray-400 font-medium">Volume</th>
                                <th class="text-right p-4 text-gray-400 font-medium">Updated</th>
                            </tr>
                        </thead>
                        <tbody id="marketInsightsTable">
                            <!-- Dynamic content will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
{% endblock %}

{% block extra_scripts %}

    <script>
        // Dashboard data management
        class WizDataDashboard {
            constructor() {
                this.marketChart = null;
                this.init();
            }

            async init() {
                await this.loadDashboardData();
                this.initChart();
                this.setupEventListeners();
                this.loadTopPerformers();
                this.loadMarketInsights();
                this.loadAIInsights();
                
                // Auto-refresh every 30 seconds
                setInterval(() => this.refreshData(), 30000);
            }

            async loadDashboardData() {
                try {
                    // Load symbols count
                    const symbolsResponse = await fetch('/api/v1/charting/symbols');
                    if (symbolsResponse.ok) {
                        const symbolsData = await symbolsResponse.json();
                        document.getElementById('trackedSymbols').textContent = symbolsData.count || 0;
                    }

                    // Set sources data - using known value from our infrastructure
                    document.getElementById('totalSources').textContent = '8';

                    // Simulate other metrics
                    document.getElementById('dataPoints').textContent = '1.2M';
                    document.getElementById('apiRequests').textContent = '45.2K';
                    
                    // Add random change percentages
                    document.getElementById('sourcesChange').textContent = '+12%';
                    document.getElementById('symbolsChange').textContent = '+8%';
                    document.getElementById('dataPointsChange').textContent = '+24%';
                    document.getElementById('requestsChange').textContent = '+156%';

                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                }
            }

            initChart() {
                const ctx = document.getElementById('marketChart');
                if (!ctx) return;

                // Generate sample data
                const generateData = (days = 30) => {
                    const data = [];
                    const now = new Date();
                    for (let i = days; i >= 0; i--) {
                        const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                        data.push({
                            x: date,
                            jse: 65000 + Math.random() * 5000,
                            btc: 45000 + Math.random() * 10000,
                            eur: 1.08 + Math.random() * 0.1
                        });
                    }
                    return data;
                };

                const data = generateData();

                this.marketChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'JSE Top 40',
                            data: data.map(d => ({ x: d.x, y: d.jse })),
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: false
                        }, {
                            label: 'BTC/USD',
                            data: data.map(d => ({ x: d.x, y: d.btc })),
                            borderColor: '#F59E0B',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.4,
                            fill: false,
                            yAxisID: 'y1'
                        }, {
                            label: 'EUR/USD',
                            data: data.map(d => ({ x: d.x, y: d.eur })),
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: false,
                            yAxisID: 'y2'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#9CA3AF'
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day',
                                    displayFormats: {
                                        day: 'MMM dd'
                                    }
                                },
                                grid: {
                                    color: '#374151'
                                },
                                ticks: {
                                    color: '#9CA3AF'
                                }
                            },
                            y: {
                                position: 'left',
                                grid: {
                                    color: '#374151'
                                },
                                ticks: {
                                    color: '#9CA3AF'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: false,
                                position: 'right'
                            },
                            y2: {
                                type: 'linear',
                                display: false,
                                position: 'right'
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
            }

            async loadTopPerformers() {
                try {
                    const response = await fetch('/api/v1/charting/screener?sort_by=change_percent&order=desc&limit=5');
                    if (!response.ok) throw new Error('Failed to load screener data');
                    
                    const data = await response.json();
                    const container = document.getElementById('topPerformers');
                    
                    if (data.results && data.results.length > 0) {
                        container.innerHTML = data.results.map(symbol => `
                            <div class="flex items-center justify-between p-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition-colors">
                                <div>
                                    <div class="font-medium text-white">${symbol.symbol}</div>
                                    <div class="text-sm text-gray-400">$${symbol.price || 'N/A'}</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-medium ${(symbol.change_percent || 0) >= 0 ? 'text-green-400' : 'text-red-400'}">
                                        ${(symbol.change_percent || 0) >= 0 ? '+' : ''}${(symbol.change_percent || 0).toFixed(2)}%
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<div class="text-center text-gray-400 py-8">No data available</div>';
                    }
                } catch (error) {
                    console.error('Error loading top performers:', error);
                    document.getElementById('topPerformers').innerHTML = '<div class="text-center text-red-400 py-8">Error loading data</div>';
                }
            }

            async loadMarketInsights() {
                try {
                    const response = await fetch('/api/v1/charting/symbols');
                    if (!response.ok) throw new Error('Failed to load symbols');
                    
                    const data = await response.json();
                    const tbody = document.getElementById('marketInsightsTable');
                    
                    if (data.symbols) {
                        const allSymbols = [
                            ...(data.symbols.jse || []),
                            ...(data.symbols.crypto || []),
                            ...(data.symbols.forex || []),
                            ...(data.symbols.stocks || [])
                        ];

                        tbody.innerHTML = allSymbols.slice(0, 10).map(symbol => {
                            const change = (Math.random() - 0.5) * 10; // Random change for demo
                            const price = Math.random() * 1000;
                            const volume = Math.floor(Math.random() * 1000000);
                            
                            return `
                                <tr class="border-b border-gray-700 hover:bg-gray-700 transition-colors">
                                    <td class="p-4 font-medium text-white">${symbol.symbol}</td>
                                    <td class="p-4 text-gray-300">${symbol.name}</td>
                                    <td class="p-4 text-gray-400">${symbol.sector || 'N/A'}</td>
                                    <td class="p-4 text-right text-white">$${price.toFixed(2)}</td>
                                    <td class="p-4 text-right ${change >= 0 ? 'text-green-400' : 'text-red-400'}">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</td>
                                    <td class="p-4 text-right text-gray-300">${volume.toLocaleString()}</td>
                                    <td class="p-4 text-right text-gray-400">Just now</td>
                                </tr>
                            `;
                        }).join('');
                    }
                } catch (error) {
                    console.error('Error loading market insights:', error);
                }
            }

            loadAIInsights() {
                const insights = [
                    {
                        symbol: 'SOL',
                        message: '300% spike in volume detected',
                        tags: ['#volume', '#alert'],
                        severity: 'high',
                        time: '2 mins ago'
                    },
                    {
                        symbol: 'ETH',
                        message: 'Sentiment shifted to neutral',
                        tags: ['#sentiment'],
                        severity: 'medium',
                        time: '5 mins ago'
                    },
                    {
                        symbol: 'JSE:NPN',
                        message: 'Technical breakout pattern forming',
                        tags: ['#technical', '#pattern'],
                        severity: 'medium',
                        time: '12 mins ago'
                    },
                    {
                        symbol: 'BTC',
                        message: 'Support level holding strong',
                        tags: ['#support', '#technical'],
                        severity: 'low',
                        time: '18 mins ago'
                    }
                ];

                const container = document.getElementById('aiInsightsList');
                container.innerHTML = insights.map(insight => `
                    <div class="p-4 bg-gray-700 rounded-lg border-l-4 ${
                        insight.severity === 'high' ? 'border-red-500' : 
                        insight.severity === 'medium' ? 'border-yellow-500' : 'border-blue-500'
                    }">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium text-white">${insight.symbol}</span>
                            <span class="text-xs text-gray-400">${insight.time}</span>
                        </div>
                        <p class="text-sm text-gray-300 mb-2">${insight.message}</p>
                        <div class="flex flex-wrap gap-1">
                            ${insight.tags.map(tag => `
                                <span class="text-xs px-2 py-1 bg-blue-600 text-blue-100 rounded">${tag}</span>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }

            setupEventListeners() {
                // App switcher dropdown
                const appSwitcher = document.getElementById('appSwitcher');
                if (appSwitcher) {
                    appSwitcher.addEventListener('click', () => {
                        const dropdown = document.getElementById('appDropdown');
                        if (dropdown) {
                            dropdown.classList.toggle('hidden');
                        }
                    });
                }

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    const appDropdown = document.getElementById('appDropdown');
                    if (!e.target.closest('#appSwitcher') && appDropdown) {
                        appDropdown.classList.add('hidden');
                    }
                });

                // AI Insights panel
                const aiInsightsBtn = document.getElementById('aiInsightsBtn');
                if (aiInsightsBtn) {
                    aiInsightsBtn.addEventListener('click', () => {
                        const panel = document.getElementById('aiInsightsPanel');
                        if (panel) {
                            panel.classList.toggle('translate-x-full');
                        }
                    });
                }

                const closeAiPanel = document.getElementById('closeAiPanel');
                if (closeAiPanel) {
                    closeAiPanel.addEventListener('click', () => {
                        const panel = document.getElementById('aiInsightsPanel');
                        if (panel) {
                            panel.classList.add('translate-x-full');
                        }
                    });
                }

                // Time range buttons
                document.querySelectorAll('.time-range-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.time-range-btn').forEach(b => {
                            b.classList.remove('bg-blue-600', 'text-white');
                            b.classList.add('text-gray-400', 'hover:text-white', 'hover:bg-gray-700');
                        });
                        btn.classList.add('bg-blue-600', 'text-white');
                        btn.classList.remove('text-gray-400', 'hover:text-white', 'hover:bg-gray-700');
                    });
                });

                // Filter buttons
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.filter-btn').forEach(b => {
                            b.classList.remove('bg-blue-600', 'text-white');
                            b.classList.add('text-gray-400', 'hover:text-white', 'hover:bg-gray-700');
                        });
                        btn.classList.add('bg-blue-600', 'text-white');
                        btn.classList.remove('text-gray-400', 'hover:text-white', 'hover:bg-gray-700');
                    });
                });

                // Search functionality
                document.addEventListener('keydown', (e) => {
                    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                        e.preventDefault();
                        document.querySelector('input[placeholder="Search..."]').focus();
                    }
                });
            }

            async refreshData() {
                await this.loadDashboardData();
                this.loadTopPerformers();
                this.loadMarketInsights();
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new WizDataDashboard();
        });
    </script>
{% endblock %}