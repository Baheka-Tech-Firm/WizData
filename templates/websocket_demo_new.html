{% extends "layout.html" %}

{% block title %}Real-time Data Stream - WizData{% endblock %}

{% block content %}
<div class="min-h-screen pt-20 pb-12">
    <!-- Hero Section -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-12">
        <div class="text-center">
            <h1 class="text-4xl md:text-6xl font-bold gradient-text mb-6" 
                x-data x-init="gsap.fromTo($el, {opacity: 0, y: 50}, {opacity: 1, y: 0, duration: 1})">
                Real-time Data Streaming
            </h1>
            <p class="text-xl text-gray-300 max-w-3xl mx-auto mb-8"
               x-data x-init="gsap.fromTo($el, {opacity: 0, y: 30}, {opacity: 1, y: 0, duration: 1, delay: 0.2})">
                Live WebSocket demonstration of African financial market data with ultra-low latency
            </p>
            
            <!-- Connection Status -->
            <div class="flex justify-center items-center space-x-6 mb-8"
                 x-data="connectionStatus()" x-init="gsap.fromTo($el, {opacity: 0, y: 30}, {opacity: 1, y: 0, duration: 1, delay: 0.4})">
                <div class="flex items-center space-x-3 glass-card px-6 py-3 rounded-full">
                    <div :class="connected ? 'bg-green-400' : 'bg-red-400'" 
                         class="w-3 h-3 rounded-full animate-pulse"></div>
                    <span class="text-white font-medium" x-text="connected ? 'Connected' : 'Disconnected'"></span>
                    <span class="text-gray-400 text-sm" x-text="'Latency: ' + latency + 'ms'"></span>
                </div>
                <button @click="toggleConnection()" 
                        :class="connected ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'"
                        class="px-6 py-3 rounded-full text-white font-medium transition-all duration-300 transform hover:scale-105">
                    <span x-text="connected ? 'Disconnect' : 'Connect'"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Live Market Data -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-16">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Live Price Feed -->
            <div class="lg:col-span-2">
                <div class="glass-card rounded-2xl p-6 mb-6"
                     x-data="liveDataFeed()" x-init="gsap.fromTo($el, {opacity: 0, y: 30}, {opacity: 1, y: 0, duration: 0.8})">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold text-white">Live Market Feed</h3>
                        <div class="flex items-center space-x-2">
                            <span class="text-gray-400 text-sm">Updates per second:</span>
                            <span class="text-cyan-400 font-mono" x-text="updatesPerSecond"></span>
                        </div>
                    </div>
                    
                    <!-- Market Data Table -->
                    <div class="space-y-3 max-h-96 overflow-y-auto">
                        <template x-for="item in marketData" :key="item.symbol">
                            <div :class="item.changeDirection === 'up' ? 'bg-green-500/10 border-green-500/30' : 
                                         item.changeDirection === 'down' ? 'bg-red-500/10 border-red-500/30' : 
                                         'bg-gray-800/30 border-gray-700'"
                                 class="flex items-center justify-between p-4 rounded-xl border transition-all duration-500">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-xl flex items-center justify-center">
                                        <span class="text-white font-bold text-sm" x-text="item.symbol.substring(0, 3)"></span>
                                    </div>
                                    <div>
                                        <div class="text-white font-bold" x-text="item.symbol"></div>
                                        <div class="text-gray-400 text-sm" x-text="item.name"></div>
                                    </div>
                                </div>
                                
                                <div class="flex items-center space-x-6">
                                    <div class="text-right">
                                        <div class="text-white font-mono text-lg" x-text="'$' + item.price.toFixed(2)"></div>
                                        <div :class="item.changeDirection === 'up' ? 'text-green-400' : 
                                                     item.changeDirection === 'down' ? 'text-red-400' : 'text-gray-400'"
                                             class="text-sm font-medium" 
                                             x-text="(item.change >= 0 ? '+' : '') + item.change.toFixed(2) + ' (' + (item.changePercent >= 0 ? '+' : '') + item.changePercent.toFixed(1) + '%)'">
                                        </div>
                                    </div>
                                    
                                    <div class="text-right">
                                        <div class="text-gray-400 text-sm">Volume</div>
                                        <div class="text-white font-mono" x-text="formatVolume(item.volume)"></div>
                                    </div>
                                    
                                    <div :class="item.changeDirection === 'up' ? 'text-green-400' : 
                                                 item.changeDirection === 'down' ? 'text-red-400' : 'text-gray-400'"
                                         class="text-2xl">
                                        <i :class="item.changeDirection === 'up' ? 'fas fa-arrow-up' : 
                                                   item.changeDirection === 'down' ? 'fas fa-arrow-down' : 
                                                   'fas fa-minus'"></i>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Live Chart -->
                <div class="glass-card rounded-2xl p-6"
                     x-data x-init="gsap.fromTo($el, {opacity: 0, y: 30}, {opacity: 1, y: 0, duration: 0.8, delay: 0.2})">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold text-white">Live Price Chart</h3>
                        <div class="flex items-center space-x-4">
                            <select class="bg-gray-800 border border-gray-600 text-white px-3 py-2 rounded-lg text-sm">
                                <option value="JSE:AGL">JSE:AGL</option>
                                <option value="JSE:SBK">JSE:SBK</option>
                                <option value="NSE:DANGCEM">NSE:DANGCEM</option>
                            </select>
                            <button class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg text-sm transition-colors">
                                Reset Zoom
                            </button>
                        </div>
                    </div>
                    
                    <div class="h-80 bg-gray-900/30 rounded-lg border border-gray-700 relative">
                        <canvas id="liveChart" class="w-full h-full"></canvas>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- WebSocket Stats -->
                <div class="glass-card rounded-2xl p-6"
                     x-data="websocketStats()" x-init="gsap.fromTo($el, {opacity: 0, x: 50}, {opacity: 1, x: 0, duration: 0.8, delay: 0.1})">
                    <h3 class="text-xl font-bold text-white mb-6">Connection Stats</h3>
                    
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Messages Received:</span>
                            <span class="text-white font-mono" x-text="messagesReceived.toLocaleString()"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Data Throughput:</span>
                            <span class="text-cyan-400 font-mono" x-text="dataThroughput + ' KB/s'"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Average Latency:</span>
                            <span class="text-green-400 font-mono" x-text="averageLatency + 'ms'"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Uptime:</span>
                            <span class="text-white font-mono" x-text="uptime"></span>
                        </div>
                    </div>
                    
                    <!-- Latency Chart -->
                    <div class="mt-6">
                        <h4 class="text-white font-medium mb-3">Latency History</h4>
                        <div class="h-24 bg-gray-900/30 rounded-lg border border-gray-700">
                            <canvas id="latencyChart" class="w-full h-full"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Active Subscriptions -->
                <div class="glass-card rounded-2xl p-6"
                     x-data="subscriptionManager()" x-init="gsap.fromTo($el, {opacity: 0, x: 50}, {opacity: 1, x: 0, duration: 0.8, delay: 0.2})">
                    <h3 class="text-xl font-bold text-white mb-6">Active Subscriptions</h3>
                    
                    <div class="space-y-3">
                        <template x-for="sub in subscriptions" :key="sub.channel">
                            <div class="flex items-center justify-between p-3 bg-gray-800/30 rounded-lg">
                                <div>
                                    <div class="text-white font-medium" x-text="sub.channel"></div>
                                    <div class="text-gray-400 text-sm" x-text="sub.description"></div>
                                </div>
                                <button @click="toggleSubscription(sub.channel)"
                                        :class="sub.active ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'"
                                        class="px-3 py-1 rounded text-white text-sm transition-colors">
                                    <span x-text="sub.active ? 'Unsub' : 'Sub'"></span>
                                </button>
                            </div>
                        </template>
                    </div>
                    
                    <button class="w-full mt-4 px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all duration-300">
                        Add New Subscription
                    </button>
                </div>

                <!-- Message Log -->
                <div class="glass-card rounded-2xl p-6"
                     x-data="messageLog()" x-init="gsap.fromTo($el, {opacity: 0, x: 50}, {opacity: 1, x: 0, duration: 0.8, delay: 0.3})">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-white">Message Log</h3>
                        <button @click="clearLog()" class="text-gray-400 hover:text-white transition-colors">
                            <i class="fas fa-trash text-sm"></i>
                        </button>
                    </div>
                    
                    <div class="max-h-64 overflow-y-auto space-y-2">
                        <template x-for="message in messages.slice(-10)" :key="message.id">
                            <div class="p-3 bg-gray-900/30 rounded-lg border border-gray-700">
                                <div class="flex items-center justify-between mb-1">
                                    <span :class="message.type === 'sent' ? 'text-blue-400' : 'text-green-400'"
                                          class="text-xs font-medium"
                                          x-text="message.type.toUpperCase()"></span>
                                    <span class="text-gray-400 text-xs" x-text="message.timestamp"></span>
                                </div>
                                <div class="text-white text-sm font-mono break-all" x-text="message.content"></div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Integration Examples -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-16">
        <div class="glass-card rounded-2xl p-8"
             x-data x-init="gsap.fromTo($el, {opacity: 0, y: 30}, {opacity: 1, y: 0, duration: 0.8, delay: 0.4})">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-white mb-4">WebSocket Integration</h2>
                <p class="text-gray-400">Connect to our real-time data streams in your applications</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- JavaScript Example -->
                <div>
                    <h3 class="text-xl font-bold text-white mb-4">JavaScript Client</h3>
                    <div class="bg-gray-900/50 rounded-xl p-6">
                        <pre class="text-sm text-gray-300 overflow-x-auto"><code><span class="text-green-400">// Connect to WizData WebSocket</span>
<span class="text-purple-400">const</span> ws = <span class="text-purple-400">new</span> <span class="text-blue-400">WebSocket</span>(<span class="text-yellow-400">'wss://api.wizdata.com/ws'</span>);

ws.<span class="text-blue-400">onopen</span> = () => {
    <span class="text-green-400">// Subscribe to JSE market data</span>
    ws.<span class="text-blue-400">send</span>(<span class="text-blue-400">JSON.stringify</span>({
        action: <span class="text-yellow-400">'subscribe'</span>,
        channel: <span class="text-yellow-400">'jse.stocks'</span>,
        symbols: [<span class="text-yellow-400">'AGL'</span>, <span class="text-yellow-400">'SBK'</span>, <span class="text-yellow-400">'NPN'</span>]
    }));
};

ws.<span class="text-blue-400">onmessage</span> = (event) => {
    <span class="text-purple-400">const</span> data = <span class="text-blue-400">JSON.parse</span>(event.data);
    <span class="text-purple-400">console.log</span>(<span class="text-yellow-400">'Price update:'</span>, data);
};
</code></pre>
                    </div>
                </div>

                <!-- Python Example -->
                <div>
                    <h3 class="text-xl font-bold text-white mb-4">Python Client</h3>
                    <div class="bg-gray-900/50 rounded-xl p-6">
                        <pre class="text-sm text-gray-300 overflow-x-auto"><code><span class="text-purple-400">import</span> websocket
<span class="text-purple-400">import</span> json

<span class="text-purple-400">def</span> <span class="text-blue-400">on_message</span>(ws, message):
    data = json.<span class="text-blue-400">loads</span>(message)
    <span class="text-purple-400">print</span>(<span class="text-yellow-400">f"Received: {data}"</span>)

<span class="text-purple-400">def</span> <span class="text-blue-400">on_open</span>(ws):
    <span class="text-green-400"># Subscribe to market data</span>
    ws.<span class="text-blue-400">send</span>(json.<span class="text-blue-400">dumps</span>({
        <span class="text-yellow-400">'action'</span>: <span class="text-yellow-400">'subscribe'</span>,
        <span class="text-yellow-400">'channel'</span>: <span class="text-yellow-400">'jse.stocks'</span>
    }))

ws = websocket.<span class="text-blue-400">WebSocketApp</span>(
    <span class="text-yellow-400">"wss://api.wizdata.com/ws"</span>,
    on_message=on_message,
    on_open=on_open
)
ws.<span class="text-blue-400">run_forever</span>()
</code></pre>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-8">
                <button class="btn-primary mr-4">View Full Documentation</button>
                <button class="btn-secondary">Download SDK</button>
            </div>
        </div>
    </div>
</div>

<!-- Notification Area -->
<div id="notifications" class="fixed bottom-4 right-4 z-50 space-y-2" x-data="notifications()">
    <template x-for="notification in notifications" :key="notification.id">
        <div :class="notification.type === 'success' ? 'bg-green-500' : 
                     notification.type === 'error' ? 'bg-red-500' : 
                     notification.type === 'info' ? 'bg-blue-500' : 'bg-gray-600'"
             class="glass-card text-white px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300"
             x-show="notification.show"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-2"
             x-transition:enter-end="opacity-100 translate-y-0">
            <div class="flex items-center space-x-3">
                <i :class="notification.type === 'success' ? 'fas fa-check-circle' : 
                           notification.type === 'error' ? 'fas fa-exclamation-circle' : 
                           notification.type === 'info' ? 'fas fa-info-circle' : 'fas fa-bell'"
                   class="text-lg"></i>
                <span x-text="notification.message"></span>
            </div>
        </div>
    </template>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Alpine.js Components
function connectionStatus() {
    return {
        connected: false,
        latency: 0,
        
        toggleConnection() {
            this.connected = !this.connected;
            if (this.connected) {
                this.simulateLatency();
            }
        },
        
        simulateLatency() {
            if (this.connected) {
                this.latency = Math.floor(Math.random() * 50) + 10;
                setTimeout(() => this.simulateLatency(), 1000);
            }
        }
    }
}

function liveDataFeed() {
    return {
        marketData: [
            { symbol: 'JSE:AGL', name: 'Anglo American plc', price: 324.15, change: 7.25, changePercent: 2.3, volume: 1250000, changeDirection: 'up' },
            { symbol: 'JSE:SBK', name: 'Standard Bank Group', price: 156.80, change: -1.90, changePercent: -1.2, volume: 890000, changeDirection: 'down' },
            { symbol: 'NSE:DANGCEM', name: 'Dangote Cement', price: 245.50, change: 1.95, changePercent: 0.8, volume: 450000, changeDirection: 'up' },
            { symbol: 'NSE:GTCO', name: 'GTCO Holdings', price: 89.20, change: 2.68, changePercent: 3.1, volume: 320000, changeDirection: 'up' }
        ],
        updatesPerSecond: 0,
        
        init() {
            this.simulateUpdates();
        },
        
        simulateUpdates() {
            setInterval(() => {
                this.marketData.forEach(item => {
                    const change = (Math.random() - 0.5) * 2;
                    item.price += change;
                    item.change += change;
                    item.changePercent = (item.change / (item.price - item.change)) * 100;
                    item.changeDirection = change > 0 ? 'up' : change < 0 ? 'down' : 'neutral';
                    item.volume += Math.floor(Math.random() * 10000);
                });
                this.updatesPerSecond = Math.floor(Math.random() * 15) + 5;
            }, 1000);
        },
        
        formatVolume(volume) {
            if (volume >= 1000000) {
                return (volume / 1000000).toFixed(1) + 'M';
            } else if (volume >= 1000) {
                return (volume / 1000).toFixed(0) + 'K';
            }
            return volume.toString();
        }
    }
}

function websocketStats() {
    return {
        messagesReceived: 0,
        dataThroughput: 0,
        averageLatency: 0,
        uptime: '00:00:00',
        startTime: Date.now(),
        
        init() {
            this.updateStats();
        },
        
        updateStats() {
            setInterval(() => {
                this.messagesReceived += Math.floor(Math.random() * 10) + 1;
                this.dataThroughput = Math.floor(Math.random() * 50) + 20;
                this.averageLatency = Math.floor(Math.random() * 30) + 15;
                
                const elapsed = Date.now() - this.startTime;
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                this.uptime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
    }
}

function subscriptionManager() {
    return {
        subscriptions: [
            { channel: 'jse.stocks', description: 'JSE Stock Prices', active: true },
            { channel: 'nse.stocks', description: 'NSE Stock Prices', active: true },
            { channel: 'forex.rates', description: 'Currency Exchange', active: false },
            { channel: 'esg.updates', description: 'ESG Data Updates', active: false }
        ],
        
        toggleSubscription(channel) {
            const sub = this.subscriptions.find(s => s.channel === channel);
            if (sub) {
                sub.active = !sub.active;
            }
        }
    }
}

function messageLog() {
    return {
        messages: [],
        messageId: 0,
        
        init() {
            this.simulateMessages();
        },
        
        simulateMessages() {
            setInterval(() => {
                this.addMessage('received', `{"symbol":"JSE:AGL","price":${(320 + Math.random() * 10).toFixed(2)}}`);
            }, 2000);
        },
        
        addMessage(type, content) {
            this.messages.push({
                id: this.messageId++,
                type: type,
                content: content,
                timestamp: new Date().toLocaleTimeString()
            });
            
            if (this.messages.length > 50) {
                this.messages.shift();
            }
        },
        
        clearLog() {
            this.messages = [];
        }
    }
}

function notifications() {
    return {
        notifications: [],
        notificationId: 0,
        
        init() {
            this.showNotification('success', 'WebSocket demo loaded successfully');
        },
        
        showNotification(type, message) {
            const notification = {
                id: this.notificationId++,
                type: type,
                message: message,
                show: true
            };
            
            this.notifications.push(notification);
            
            setTimeout(() => {
                notification.show = false;
                setTimeout(() => {
                    const index = this.notifications.indexOf(notification);
                    if (index > -1) {
                        this.notifications.splice(index, 1);
                    }
                }, 300);
            }, 3000);
        }
    }
}

// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    // Live price chart
    const liveCtx = document.getElementById('liveChart').getContext('2d');
    const liveChart = new Chart(liveCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Price',
                data: [],
                borderColor: '#06b6d4',
                backgroundColor: 'rgba(6, 182, 212, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: { grid: { color: 'rgba(75, 85, 99, 0.3)' }, ticks: { color: '#9ca3af' } },
                y: { grid: { color: 'rgba(75, 85, 99, 0.3)' }, ticks: { color: '#9ca3af' } }
            },
            animation: { duration: 0 }
        }
    });
    
    // Latency chart
    const latencyCtx = document.getElementById('latencyChart').getContext('2d');
    const latencyChart = new Chart(latencyCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Latency',
                data: [],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderWidth: 1,
                fill: true,
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { display: false },
                y: { display: false }
            },
            animation: { duration: 0 }
        }
    });
    
    // Simulate real-time updates
    setInterval(() => {
        const now = new Date().toLocaleTimeString();
        const price = 320 + Math.random() * 10;
        const latency = Math.random() * 50 + 10;
        
        // Update live chart
        liveChart.data.labels.push(now);
        liveChart.data.datasets[0].data.push(price);
        
        if (liveChart.data.labels.length > 20) {
            liveChart.data.labels.shift();
            liveChart.data.datasets[0].data.shift();
        }
        
        liveChart.update('none');
        
        // Update latency chart
        latencyChart.data.labels.push(now);
        latencyChart.data.datasets[0].data.push(latency);
        
        if (latencyChart.data.labels.length > 10) {
            latencyChart.data.labels.shift();
            latencyChart.data.datasets[0].data.shift();
        }
        
        latencyChart.update('none');
    }, 1000);
});
</script>
{% endblock %}
