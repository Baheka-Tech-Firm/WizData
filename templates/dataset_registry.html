{% extends "layout.html" %}

{% block title %}WizData - Dataset Registry{% endblock %}

{% block content %}
<div x-data="datasetRegistryController()" class="min-h-screen bg-gray-900">
    <!-- Header Section -->
    <div class="relative overflow-hidden bg-gradient-to-br from-gray-900 via-indigo-900 to-purple-900 py-16">
        <div class="absolute inset-0 bg-black/30"></div>
        <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <h1 class="text-4xl md:text-6xl font-bold text-white mb-6">
                    Dataset Registry
                </h1>
                <p class="text-xl text-gray-300 max-w-3xl mx-auto">
                    Manage, register, and monitor your datasets in our comprehensive data catalog
                </p>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-gray-800 rounded-xl border border-gray-700 mb-8">
            <div class="flex flex-wrap border-b border-gray-700">
                <button @click="activeTab = 'browse'" 
                        :class="activeTab === 'browse' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-white'"
                        class="px-6 py-4 font-medium transition-colors">
                    Browse Registry
                </button>
                <button @click="activeTab = 'register'" 
                        :class="activeTab === 'register' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-white'"
                        class="px-6 py-4 font-medium transition-colors">
                    Register Dataset
                </button>
                <button @click="activeTab = 'manage'" 
                        :class="activeTab === 'manage' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-white'"
                        class="px-6 py-4 font-medium transition-colors">
                    Manage Datasets
                </button>
                <button @click="activeTab = 'analytics'" 
                        :class="activeTab === 'analytics' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-white'"
                        class="px-6 py-4 font-medium transition-colors">
                    Analytics
                </button>
            </div>

            <!-- Registry Stats -->
            <div class="p-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-blue-400" x-text="registryStats.total"></div>
                        <div class="text-sm text-gray-400">Total Datasets</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-green-400" x-text="registryStats.verified"></div>
                        <div class="text-sm text-gray-400">Verified</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-yellow-400" x-text="registryStats.pending"></div>
                        <div class="text-sm text-gray-400">Pending</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-purple-400" x-text="registryStats.providers"></div>
                        <div class="text-sm text-gray-400">Data Providers</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Browse Registry Tab -->
        <div x-show="activeTab === 'browse'" x-transition:enter="transition ease-out duration-300" 
             x-transition:enter-start="opacity-0 transform translate-y-4" 
             x-transition:enter-end="opacity-100 transform translate-y-0">
            
            <!-- Search and Filters -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 mb-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Search Registry</label>
                        <input type="text" x-model="searchQuery" @input="filterRegistry()"
                               placeholder="Search datasets, schemas, tags..."
                               class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Category</label>
                        <select x-model="selectedCategory" @change="filterRegistry()"
                                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-blue-500">
                            <option value="">All Categories</option>
                            <option value="financial">Financial</option>
                            <option value="esg">ESG</option>
                            <option value="market">Market Data</option>
                            <option value="economic">Economic</option>
                            <option value="alternative">Alternative</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Status</label>
                        <select x-model="selectedStatus" @change="filterRegistry()"
                                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-blue-500">
                            <option value="">All Statuses</option>
                            <option value="verified">Verified</option>
                            <option value="pending">Pending</option>
                            <option value="draft">Draft</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Registry Entries -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <template x-for="entry in filteredRegistry" :key="entry.id">
                    <div class="bg-gray-800 rounded-xl border border-gray-700 hover:border-blue-500 transition-all duration-300">
                        <div class="p-6">
                            <!-- Entry Header -->
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex-1">
                                    <h3 class="text-xl font-semibold text-white mb-2" x-text="entry.name"></h3>
                                    <div class="flex items-center space-x-2 mb-2">
                                        <span class="px-2 py-1 text-xs rounded-full"
                                              :class="entry.status === 'verified' ? 'bg-green-600 text-white' : 
                                                      entry.status === 'pending' ? 'bg-yellow-600 text-white' : 
                                                      'bg-gray-600 text-white'" 
                                              x-text="entry.status.charAt(0).toUpperCase() + entry.status.slice(1)"></span>
                                        <span class="px-2 py-1 bg-blue-600 text-white text-xs rounded-full" x-text="entry.category"></span>
                                    </div>
                                    <p class="text-gray-400 text-sm" x-text="entry.description"></p>
                                </div>
                                <div class="ml-4">
                                    <button @click="viewDetails(entry)" class="text-blue-400 hover:text-blue-300">
                                        <i data-lucide="external-link" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Schema Info -->
                            <div class="mb-4">
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-400">Schema Version</span>
                                    <span class="text-white font-mono" x-text="entry.schema_version"></span>
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-400">Data Provider</span>
                                    <span class="text-white" x-text="entry.provider"></span>
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-400">Last Updated</span>
                                    <span class="text-white" x-text="entry.last_updated"></span>
                                </div>
                            </div>

                            <!-- Tags -->
                            <div class="mb-4">
                                <div class="flex flex-wrap gap-1">
                                    <template x-for="tag in entry.tags" :key="tag">
                                        <span class="px-2 py-1 bg-gray-700 text-gray-300 text-xs rounded" x-text="tag"></span>
                                    </template>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="flex space-x-2">
                                <button @click="viewSchema(entry)" 
                                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                    View Schema
                                </button>
                                <button @click="downloadMetadata(entry)" 
                                        class="flex-1 bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                    Download
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Register Dataset Tab -->
        <div x-show="activeTab === 'register'" x-transition:enter="transition ease-out duration-300" 
             x-transition:enter-start="opacity-0 transform translate-y-4" 
             x-transition:enter-end="opacity-100 transform translate-y-0">
            
            <div class="bg-gray-800 rounded-xl border border-gray-700 p-8">
                <h2 class="text-2xl font-bold text-white mb-6">Register New Dataset</h2>
                
                <form @submit.prevent="registerDataset()" class="space-y-6">
                    <!-- Basic Information -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Dataset Name</label>
                            <input type="text" x-model="newDataset.name" required
                                   class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Category</label>
                            <select x-model="newDataset.category" required
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-blue-500">
                                <option value="">Select Category</option>
                                <option value="financial">Financial</option>
                                <option value="esg">ESG</option>
                                <option value="market">Market Data</option>
                                <option value="economic">Economic</option>
                                <option value="alternative">Alternative</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Description</label>
                        <textarea x-model="newDataset.description" rows="3" required
                                  class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- Data Source Information -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Data Provider</label>
                            <input type="text" x-model="newDataset.provider" required
                                   class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Update Frequency</label>
                            <select x-model="newDataset.frequency" required
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-blue-500">
                                <option value="">Select Frequency</option>
                                <option value="real-time">Real-time</option>
                                <option value="hourly">Hourly</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                    </div>

                    <!-- Schema Upload -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Dataset Schema</label>
                        <div class="border-2 border-dashed border-gray-600 rounded-lg p-6 text-center hover:border-blue-500 transition-colors">
                            <i data-lucide="upload" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                            <p class="text-gray-400 mb-2">Upload schema file (JSON, YAML, or CSV)</p>
                            <input type="file" accept=".json,.yaml,.yml,.csv" class="hidden" @change="handleSchemaUpload($event)">
                            <button type="button" onclick="this.previousElementSibling.click()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                Choose File
                            </button>
                        </div>
                    </div>

                    <!-- Tags -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Tags</label>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <template x-for="tag in newDataset.tags" :key="tag">
                                <span class="px-2 py-1 bg-blue-600 text-white text-sm rounded flex items-center">
                                    <span x-text="tag"></span>
                                    <button type="button" @click="removeTag(tag)" class="ml-1 text-blue-200 hover:text-white">
                                        <i data-lucide="x" class="w-3 h-3"></i>
                                    </button>
                                </span>
                            </template>
                        </div>
                        <div class="flex">
                            <input type="text" x-model="newTag" @keyup.enter="addTag()" placeholder="Add tag..."
                                   class="flex-1 bg-gray-700 border border-gray-600 rounded-l-lg px-4 py-2 text-white focus:ring-2 focus:ring-blue-500">
                            <button type="button" @click="addTag()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-r-lg transition-colors">
                                Add
                            </button>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="flex justify-end">
                        <button type="submit" 
                                class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-medium transition-colors">
                            Register Dataset
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Manage Datasets Tab -->
        <div x-show="activeTab === 'manage'" x-transition:enter="transition ease-out duration-300" 
             x-transition:enter-start="opacity-0 transform translate-y-4" 
             x-transition:enter-end="opacity-100 transform translate-y-0">
            
            <div class="bg-gray-800 rounded-xl border border-gray-700">
                <div class="p-6 border-b border-gray-700">
                    <h2 class="text-2xl font-bold text-white">Manage Your Datasets</h2>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-sm font-medium text-gray-300">Name</th>
                                <th class="px-6 py-3 text-left text-sm font-medium text-gray-300">Status</th>
                                <th class="px-6 py-3 text-left text-sm font-medium text-gray-300">Category</th>
                                <th class="px-6 py-3 text-left text-sm font-medium text-gray-300">Last Updated</th>
                                <th class="px-6 py-3 text-left text-sm font-medium text-gray-300">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            <template x-for="dataset in managedDatasets" :key="dataset.id">
                                <tr class="hover:bg-gray-700">
                                    <td class="px-6 py-4 text-sm text-white" x-text="dataset.name"></td>
                                    <td class="px-6 py-4">
                                        <span class="px-2 py-1 text-xs rounded-full"
                                              :class="dataset.status === 'verified' ? 'bg-green-600 text-white' : 
                                                      dataset.status === 'pending' ? 'bg-yellow-600 text-white' : 
                                                      'bg-gray-600 text-white'" 
                                              x-text="dataset.status"></span>
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-300" x-text="dataset.category"></td>
                                    <td class="px-6 py-4 text-sm text-gray-300" x-text="dataset.last_updated"></td>
                                    <td class="px-6 py-4">
                                        <div class="flex space-x-2">
                                            <button @click="editDataset(dataset)" class="text-blue-400 hover:text-blue-300">
                                                <i data-lucide="edit" class="w-4 h-4"></i>
                                            </button>
                                            <button @click="deleteDataset(dataset)" class="text-red-400 hover:text-red-300">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div x-show="activeTab === 'analytics'" x-transition:enter="transition ease-out duration-300" 
             x-transition:enter-start="opacity-0 transform translate-y-4" 
             x-transition:enter-end="opacity-100 transform translate-y-0">
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Registration Trends -->
                <div class="bg-gray-800 rounded-xl border border-gray-700 p-6">
                    <h3 class="text-xl font-semibold text-white mb-4">Registration Trends</h3>
                    <div class="h-64 bg-gray-700 rounded-lg flex items-center justify-center">
                        <span class="text-gray-400">Chart: Dataset registrations over time</span>
                    </div>
                </div>

                <!-- Category Distribution -->
                <div class="bg-gray-800 rounded-xl border border-gray-700 p-6">
                    <h3 class="text-xl font-semibold text-white mb-4">Category Distribution</h3>
                    <div class="h-64 bg-gray-700 rounded-lg flex items-center justify-center">
                        <span class="text-gray-400">Chart: Datasets by category</span>
                    </div>
                </div>

                <!-- Popular Datasets -->
                <div class="bg-gray-800 rounded-xl border border-gray-700 p-6">
                    <h3 class="text-xl font-semibold text-white mb-4">Most Accessed Datasets</h3>
                    <div class="space-y-3">
                        <template x-for="(dataset, index) in popularDatasets" :key="dataset.id">
                            <div class="flex items-center justify-between p-3 bg-gray-700 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <div class="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-bold" 
                                         x-text="index + 1"></div>
                                    <span class="text-white" x-text="dataset.name"></span>
                                </div>
                                <span class="text-gray-400" x-text="dataset.access_count + ' accesses'"></span>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Data Quality Metrics -->
                <div class="bg-gray-800 rounded-xl border border-gray-700 p-6">
                    <h3 class="text-xl font-semibold text-white mb-4">Quality Metrics</h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-400">Schema Compliance</span>
                                <span class="text-white">94%</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div class="bg-green-600 h-2 rounded-full" style="width: 94%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-400">Data Freshness</span>
                                <span class="text-white">87%</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: 87%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-400">Completeness</span>
                                <span class="text-white">91%</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div class="bg-purple-600 h-2 rounded-full" style="width: 91%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function datasetRegistryController() {
    return {
        activeTab: 'browse',
        searchQuery: '',
        selectedCategory: '',
        selectedStatus: '',
        newTag: '',
        
        registryStats: {
            total: 73,
            verified: 68,
            pending: 5,
            providers: 12
        },

        newDataset: {
            name: '',
            category: '',
            description: '',
            provider: '',
            frequency: '',
            tags: []
        },

        registryEntries: [
            {
                id: 1,
                name: "JSE Real-time Market Data",
                category: "financial",
                status: "verified",
                description: "Real-time stock prices and trading data from JSE",
                schema_version: "v2.1.0",
                provider: "JSE Ltd",
                last_updated: "2024-01-28",
                tags: ["real-time", "stocks", "jse", "trading"]
            },
            {
                id: 2,
                name: "African ESG Dataset",
                category: "esg",
                status: "verified",
                description: "ESG metrics for African companies",
                schema_version: "v1.3.2",
                provider: "WizData ESG",
                last_updated: "2024-01-25",
                tags: ["esg", "africa", "sustainability", "governance"]
            },
            {
                id: 3,
                name: "Cryptocurrency Sentiment",
                category: "alternative",
                status: "pending",
                description: "Social media sentiment analysis for cryptocurrencies",
                schema_version: "v1.0.0",
                provider: "CryptoSentiment Inc",
                last_updated: "2024-01-30",
                tags: ["crypto", "sentiment", "social-media", "alternative"]
            }
        ],

        managedDatasets: [
            {
                id: 1,
                name: "My Custom Dataset",
                status: "verified",
                category: "financial",
                last_updated: "2024-01-28"
            },
            {
                id: 2,
                name: "Private ESG Data",
                status: "pending",
                category: "esg",
                last_updated: "2024-01-30"
            }
        ],

        popularDatasets: [
            { id: 1, name: "JSE Real-time Data", access_count: 15420 },
            { id: 2, name: "African ESG Scores", access_count: 8937 },
            { id: 3, name: "Crypto Market Data", access_count: 7321 },
            { id: 4, name: "Economic Indicators", access_count: 5689 },
            { id: 5, name: "Dividend Calendar", access_count: 4123 }
        ],

        filteredRegistry: [],

        init() {
            this.filteredRegistry = this.registryEntries;
        },

        filterRegistry() {
            this.filteredRegistry = this.registryEntries.filter(entry => {
                const matchesSearch = this.searchQuery === '' || 
                    entry.name.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
                    entry.description.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
                    entry.tags.some(tag => tag.toLowerCase().includes(this.searchQuery.toLowerCase()));

                const matchesCategory = this.selectedCategory === '' || entry.category === this.selectedCategory;
                const matchesStatus = this.selectedStatus === '' || entry.status === this.selectedStatus;

                return matchesSearch && matchesCategory && matchesStatus;
            });
        },

        addTag() {
            if (this.newTag.trim() && !this.newDataset.tags.includes(this.newTag.trim())) {
                this.newDataset.tags.push(this.newTag.trim());
                this.newTag = '';
            }
        },

        removeTag(tag) {
            this.newDataset.tags = this.newDataset.tags.filter(t => t !== tag);
        },

        handleSchemaUpload(event) {
            const file = event.target.files[0];
            if (file) {
                // Handle schema file upload
                console.log('Schema file uploaded:', file.name);
            }
        },

        registerDataset() {
            // Handle dataset registration
            alert('Dataset registration submitted for review');
            // Reset form
            this.newDataset = {
                name: '',
                category: '',
                description: '',
                provider: '',
                frequency: '',
                tags: []
            };
        },

        viewDetails(entry) {
            alert(`Viewing details for: ${entry.name}`);
        },

        viewSchema(entry) {
            alert(`Viewing schema for: ${entry.name}`);
        },

        downloadMetadata(entry) {
            alert(`Downloading metadata for: ${entry.name}`);
        },

        editDataset(dataset) {
            alert(`Editing: ${dataset.name}`);
        },

        deleteDataset(dataset) {
            if (confirm(`Are you sure you want to delete ${dataset.name}?`)) {
                // Handle deletion
                alert('Dataset deleted');
            }
        }
    }
}
</script>
{% endblock %}
