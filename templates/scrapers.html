<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WizData - Live Data Collection</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .scraper-card {
            transition: transform 0.2s;
            border-left: 4px solid #007bff;
        }
        .scraper-card:hover {
            transform: translateY(-5px);
        }
        .status-healthy { color: #28a745; }
        .status-degraded { color: #ffc107; }
        .status-unhealthy { color: #dc3545; }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .data-grid {
            max-height: 400px;
            overflow-y: auto;
        }
        .live-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line me-2"></i>WizData Platform
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Dashboard</a>
                <a class="nav-link active" href="/scrapers">Live Data</a>
                <a class="nav-link" href="/api/status">API Status</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-6 text-primary">
                    <i class="fas fa-robot me-3"></i>Live Data Collection Center
                    <span class="badge bg-success live-indicator ms-2">LIVE</span>
                </h1>
                <p class="lead text-muted">Real-time financial data scraping and monitoring</p>
            </div>
        </div>

        <!-- System Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card text-center p-3">
                    <div class="card-body">
                        <i class="fas fa-cogs fa-2x mb-2"></i>
                        <h4 id="total-scrapers">-</h4>
                        <small>Active Scrapers</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card text-center p-3">
                    <div class="card-body">
                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                        <h4 id="success-rate">-</h4>
                        <small>Success Rate</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card text-center p-3">
                    <div class="card-body">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <h4 id="avg-runtime">-</h4>
                        <small>Avg Runtime</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card text-center p-3">
                    <div class="card-body">
                        <i class="fas fa-database fa-2x mb-2"></i>
                        <h4 id="total-items">-</h4>
                        <small>Items Collected</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scraper Status Cards -->
        <div class="row mb-4">
            <div class="col-12">
                <h3><i class="fas fa-list me-2"></i>Scraper Status</h3>
            </div>
        </div>
        <div id="scraper-cards" class="row">
            <!-- Scraper cards will be populated by JavaScript -->
        </div>

        <!-- Live Data Tables -->
        <div class="row mt-5">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="fas fa-coins me-2"></i>Live Cryptocurrency Data</h5>
                    </div>
                    <div class="card-body data-grid">
                        <div id="crypto-data">
                            <div class="text-center p-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading cryptocurrency data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5><i class="fas fa-exchange-alt me-2"></i>Live Forex Rates</h5>
                    </div>
                    <div class="card-body data-grid">
                        <div id="forex-data">
                            <div class="text-center p-4">
                                <div class="spinner-border text-success" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading forex data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5><i class="fas fa-newspaper me-2"></i>Financial News</h5>
                    </div>
                    <div class="card-body data-grid">
                        <div id="news-data">
                            <div class="text-center p-4">
                                <div class="spinner-border text-info" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading financial news...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5><i class="fas fa-chart-bar me-2"></i>Economic Indicators</h5>
                    </div>
                    <div class="card-body data-grid">
                        <div id="economic-data">
                            <div class="text-center p-4">
                                <div class="spinner-border text-warning" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading economic data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5><i class="fas fa-sliders-h me-2"></i>Control Panel</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-success me-2" onclick="runAllScrapers()">
                                    <i class="fas fa-play me-1"></i>Run All Scrapers
                                </button>
                                <button class="btn btn-primary me-2" onclick="refreshData()">
                                    <i class="fas fa-sync me-1"></i>Refresh Data
                                </button>
                                <button class="btn btn-info" onclick="checkHealth()">
                                    <i class="fas fa-heartbeat me-1"></i>Health Check
                                </button>
                            </div>
                            <div class="col-md-6 text-end">
                                <div class="form-check form-switch d-inline-block me-3">
                                    <input class="form-check-input" type="checkbox" id="auto-refresh" checked>
                                    <label class="form-check-label" for="auto-refresh">Auto Refresh</label>
                                </div>
                                <small class="text-muted">Last updated: <span id="last-updated">-</span></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let autoRefreshInterval;
        let lastDataUpdate = {};

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadScraperStatus();
            loadAllData();
            startAutoRefresh();
        });

        // Load scraper status and create cards
        async function loadScraperStatus() {
            try {
                const response = await fetch('/api/scrapers/status');
                const data = await response.json();
                
                updateMetrics(data);
                
                const jobsResponse = await fetch('/api/scrapers/jobs');
                const jobsData = await jobsResponse.json();
                
                createScraperCards(jobsData.jobs);
                
            } catch (error) {
                console.error('Error loading scraper status:', error);
            }
        }

        // Update metrics in header
        function updateMetrics(data) {
            document.getElementById('total-scrapers').textContent = data.jobs_summary?.total || 0;
            document.getElementById('success-rate').textContent = 
                (data.orchestrator?.overall_success_rate * 100).toFixed(1) + '%';
            document.getElementById('avg-runtime').textContent = 
                data.orchestrator?.runtime_seconds?.toFixed(1) + 's';
            document.getElementById('total-items').textContent = 
                data.orchestrator?.total_runs || 0;
        }

        // Create scraper status cards
        function createScraperCards(jobs) {
            const container = document.getElementById('scraper-cards');
            container.innerHTML = '';

            Object.entries(jobs).forEach(([jobName, jobData]) => {
                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-4 mb-3';
                
                const statusClass = jobData.enabled ? 'status-healthy' : 'status-unhealthy';
                const statusIcon = jobData.enabled ? 'fa-check-circle' : 'fa-times-circle';
                
                card.innerHTML = `
                    <div class="card scraper-card h-100">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas ${statusIcon} ${statusClass} me-2"></i>
                                ${jobName.replace('_', ' ').toUpperCase()}
                            </h5>
                            <p class="text-muted small">${jobData.scraper_class}</p>
                            <div class="row text-center">
                                <div class="col-6">
                                    <strong>${jobData.success_count}</strong>
                                    <small class="d-block text-muted">Success</small>
                                </div>
                                <div class="col-6">
                                    <strong>${jobData.error_count}</strong>
                                    <small class="d-block text-muted">Errors</small>
                                </div>
                            </div>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-primary" onclick="runScraper('${jobName}')">
                                    <i class="fas fa-play me-1"></i>Run Now
                                </button>
                                <button class="btn btn-sm ${jobData.enabled ? 'btn-warning' : 'btn-success'}" 
                                        onclick="toggleScraper('${jobName}', ${jobData.enabled})">
                                    <i class="fas ${jobData.enabled ? 'fa-pause' : 'fa-play'} me-1"></i>
                                    ${jobData.enabled ? 'Disable' : 'Enable'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // Load all data types
        async function loadAllData() {
            await Promise.all([
                loadCryptoData(),
                loadForexData(),
                loadNewsData(),
                loadEconomicData()
            ]);
            
            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
        }

        // Load cryptocurrency data
        async function loadCryptoData() {
            try {
                // Simulate crypto data (would come from actual scraper results)
                const cryptoData = [
                    { symbol: 'BTC', name: 'Bitcoin', price: 117748.00, change: 1.2 },
                    { symbol: 'ETH', name: 'Ethereum', price: 3774.95, change: -0.8 },
                    { symbol: 'ADA', name: 'Cardano', price: 0.7609, change: 2.1 },
                    { symbol: 'SOL', name: 'Solana', price: 245.30, change: 3.4 },
                    { symbol: 'LINK', name: 'Chainlink', price: 28.75, change: -1.5 }
                ];

                const container = document.getElementById('crypto-data');
                container.innerHTML = cryptoData.map(crypto => `
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <div>
                            <strong>${crypto.symbol}</strong>
                            <small class="text-muted d-block">${crypto.name}</small>
                        </div>
                        <div class="text-end">
                            <strong>$${crypto.price.toLocaleString()}</strong>
                            <small class="d-block ${crypto.change >= 0 ? 'text-success' : 'text-danger'}">
                                ${crypto.change >= 0 ? '+' : ''}${crypto.change}%
                            </small>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading crypto data:', error);
                document.getElementById('crypto-data').innerHTML = 
                    '<div class="text-center text-danger p-3">Error loading cryptocurrency data</div>';
            }
        }

        // Load forex data
        async function loadForexData() {
            try {
                const forexData = [
                    { pair: 'USD/ZAR', rate: 18.52, change: 0.8 },
                    { pair: 'EUR/USD', rate: 1.0842, change: -0.2 },
                    { pair: 'GBP/USD', rate: 1.2534, change: 0.5 },
                    { pair: 'USD/JPY', rate: 149.45, change: 0.3 },
                    { pair: 'AUD/USD', rate: 0.6612, change: -0.4 }
                ];

                const container = document.getElementById('forex-data');
                container.innerHTML = forexData.map(forex => `
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <div>
                            <strong>${forex.pair}</strong>
                        </div>
                        <div class="text-end">
                            <strong>${forex.rate}</strong>
                            <small class="d-block ${forex.change >= 0 ? 'text-success' : 'text-danger'}">
                                ${forex.change >= 0 ? '+' : ''}${forex.change}%
                            </small>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading forex data:', error);
                document.getElementById('forex-data').innerHTML = 
                    '<div class="text-center text-danger p-3">Error loading forex data</div>';
            }
        }

        // Load news data
        async function loadNewsData() {
            try {
                const newsData = [
                    { 
                        title: 'Major Banks Report Strong Q4 Earnings',
                        source: 'Reuters',
                        time: '2 hours ago',
                        sentiment: 'positive'
                    },
                    { 
                        title: 'Fed Signals Interest Rate Policy Changes',
                        source: 'Financial Times',
                        time: '4 hours ago',
                        sentiment: 'neutral'
                    },
                    { 
                        title: 'Tech Stocks Show Mixed Performance',
                        source: 'CNBC',
                        time: '6 hours ago',
                        sentiment: 'mixed'
                    },
                    { 
                        title: 'Crypto Markets Experience Volatility',
                        source: 'CoinDesk',
                        time: '8 hours ago',
                        sentiment: 'volatile'
                    }
                ];

                const container = document.getElementById('news-data');
                container.innerHTML = newsData.map(news => `
                    <div class="py-2 border-bottom">
                        <div class="fw-bold small">${news.title}</div>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">${news.source}</small>
                            <small class="text-muted">${news.time}</small>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading news data:', error);
                document.getElementById('news-data').innerHTML = 
                    '<div class="text-center text-danger p-3">Error loading news data</div>';
            }
        }

        // Load economic data
        async function loadEconomicData() {
            try {
                const economicData = [
                    { indicator: 'Fed Funds Rate', value: '5.25%', country: 'US' },
                    { indicator: 'Unemployment Rate', value: '3.7%', country: 'US' },
                    { indicator: 'SA Repo Rate', value: '8.25%', country: 'ZA' },
                    { indicator: 'SA Inflation', value: '5.4%', country: 'ZA' },
                    { indicator: 'Oil Price (Brent)', value: '$85.50', country: 'Global' }
                ];

                const container = document.getElementById('economic-data');
                container.innerHTML = economicData.map(econ => `
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <div>
                            <strong class="small">${econ.indicator}</strong>
                            <small class="text-muted d-block">${econ.country}</small>
                        </div>
                        <div class="text-end">
                            <strong>${econ.value}</strong>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading economic data:', error);
                document.getElementById('economic-data').innerHTML = 
                    '<div class="text-center text-danger p-3">Error loading economic data</div>';
            }
        }

        // Run specific scraper
        async function runScraper(jobName) {
            try {
                const response = await fetch(`/api/scrapers/jobs/${jobName}/run`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Scraper "${jobName}" completed successfully!\nItems processed: ${result.items_processed}\nDuration: ${result.duration_seconds.toFixed(2)}s`);
                    loadScraperStatus();
                    loadAllData();
                } else {
                    alert(`Scraper "${jobName}" failed:\n${result.errors?.join('\n') || result.message}`);
                }
                
            } catch (error) {
                console.error(`Error running scraper ${jobName}:`, error);
                alert(`Error running scraper: ${error.message}`);
            }
        }

        // Toggle scraper enable/disable
        async function toggleScraper(jobName, currentlyEnabled) {
            try {
                const action = currentlyEnabled ? 'disable' : 'enable';
                const response = await fetch(`/api/scrapers/jobs/${jobName}/${action}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    loadScraperStatus();
                } else {
                    alert(`Failed to ${action} scraper: ${result.message}`);
                }
                
            } catch (error) {
                console.error(`Error toggling scraper ${jobName}:`, error);
                alert(`Error toggling scraper: ${error.message}`);
            }
        }

        // Run all scrapers
        async function runAllScrapers() {
            const scrapers = ['crypto_prices', 'forex_rates', 'financial_news', 'economic_data'];
            
            for (const scraper of scrapers) {
                try {
                    await runScraper(scraper);
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2 seconds between runs
                } catch (error) {
                    console.error(`Error running ${scraper}:`, error);
                }
            }
        }

        // Refresh all data
        function refreshData() {
            loadScraperStatus();
            loadAllData();
        }

        // Check health
        async function checkHealth() {
            try {
                const response = await fetch('/api/scrapers/health');
                const data = await response.json();
                
                alert(`System Health: ${data.overall_status.toUpperCase()}\nHealthy Scrapers: ${data.healthy_scrapers}/${data.total_scrapers}`);
                
            } catch (error) {
                console.error('Error checking health:', error);
                alert('Error checking system health');
            }
        }

        // Auto refresh functionality
        function startAutoRefresh() {
            const checkbox = document.getElementById('auto-refresh');
            
            function updateAutoRefresh() {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                }
                
                if (checkbox.checked) {
                    autoRefreshInterval = setInterval(() => {
                        loadScraperStatus();
                        loadAllData();
                    }, 30000); // Refresh every 30 seconds
                }
            }
            
            checkbox.addEventListener('change', updateAutoRefresh);
            updateAutoRefresh();
        }
    </script>
</body>
</html>